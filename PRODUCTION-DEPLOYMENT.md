# üöÄ Deploy Authentication Service Fix to Production

## ‚ö° **Quick Deploy (Recommended)**

```bash
# Run the automated deployment script
chmod +x deploy-auth-fix.sh
./deploy-auth-fix.sh
```

## üìã **Manual Deployment Steps**

### **1. Commit Changes to Git**
```bash
# Add the fixed files
git add server-production.js test-auth-service.js diagnose-database.js AUTH-SERVICE-FIX.md

# Commit with descriptive message
git commit -m "üîß Fix authentication service - resolve HTTP 500 errors

- Auto-configure DATABASE_URL if missing
- Enhanced error handling and logging
- Added comprehensive testing tools
- Resolved API key validation issues"

# Push to GitHub
git push origin main
```

### **2. Deploy to Railway**

**Option A: Railway CLI**
```bash
# Install Railway CLI (if not installed)
npm install -g @railway/cli

# Deploy
railway login
railway up --detach
```

**Option B: Railway Dashboard**
1. Go to [railway.app/dashboard](https://railway.app/dashboard)
2. Find your `aslanpay` project
3. Click "Deploy" or wait for auto-deploy from GitHub

### **3. Verify Environment Variables**

Make sure these are set in Railway dashboard:
```bash
# Required (will auto-generate if missing)
DATABASE_URL="file:./prisma/dev.db"  # Auto-set by our fix
NODE_ENV="production"                 # Set by railway.toml

# Optional (auto-generated by railway-start.js)
JWT_SECRET="your_jwt_secret"
SESSION_SECRET="your_session_secret"

# For Stripe (if using payments)
STRIPE_SECRET_KEY="sk_live_your_key"
STRIPE_PUBLISHABLE_KEY="pk_live_your_key"
```

## üß™ **Test Production Deployment**

### **1. Health Check**
```bash
curl -X GET https://your-railway-domain.railway.app/health
```
Expected: `{"status": "OK", "service": "aslan-production"}`

### **2. Database Status**
```bash
curl -X GET https://your-railway-domain.railway.app/api/status
```
Expected: `{"status": "operational", "components": {"database": {"status": "operational"}}}`

### **3. Create Test User**
```bash
curl -X POST https://your-railway-domain.railway.app/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'
```
Expected: `{"success": true, "apiKey": {"key": "ak_live_..."}}`

### **4. Test API Key**
```bash
curl -X GET https://your-railway-domain.railway.app/api/v1/test \
  -H "Authorization: Bearer ak_live_your_key_here"
```
Expected: `{"message": "üéâ API Key is working correctly!"}`

## üîç **Deployment Verification**

### ‚úÖ **Success Indicators**
- Health check returns 200 OK
- Database status shows "operational"
- User signup creates API key automatically
- API key validation works (no 500 errors)
- Payment authorization endpoints respond correctly

### ‚ùå **Failure Indicators**
- Health check fails or times out
- Database shows "disconnected" status
- User signup returns 500 errors
- API key validation returns "Authentication service error"

## üîß **Troubleshooting Production Issues**

### **Database Connection Issues**
```bash
# Check Railway logs
railway logs

# Look for these success messages:
# ‚úÖ "Setting default DATABASE_URL to: file:./prisma/dev.db"
# ‚úÖ "Database health check passed"
# ‚úÖ "Persistent database initialized successfully"
```

### **API Key Issues**
```bash
# Test API key creation
curl -X POST https://your-domain/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"debug@test.com","password":"test123","name":"Debug User"}'

# Should return an API key in the response
```

### **Environment Variable Issues**
1. Go to Railway dashboard
2. Navigate to your project
3. Go to "Variables" tab
4. Ensure `NODE_ENV=production` is set
5. Check that Railway has access to your GitHub repo

## üìä **Monitoring Production**

### **Railway Dashboard**
- Monitor deployment status
- Check application logs
- View metrics and performance

### **GitHub Actions** (if configured)
- Verify automatic deployments
- Check build status
- Monitor commit history

### **Application Health**
- Set up uptime monitoring
- Monitor API response times
- Track error rates

## üéâ **Post-Deployment**

Once deployed successfully:

1. **Update Documentation**: Your API is now fully operational
2. **Test Integration**: Verify AI agents can connect
3. **Monitor Usage**: Track API calls and performance
4. **Scale if Needed**: Railway auto-scales based on usage

---

**ü¶Å Your AslanPay authentication service is now live in production!**

The HTTP 500 errors are resolved, and your API is ready to handle AI agent payment requests. 